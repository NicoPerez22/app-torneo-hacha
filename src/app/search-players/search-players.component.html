<div class="container">
  <!-- Header Section -->
  <div class="players-header">
    <div class="header-content">
      <h1 class="players-title text-info">
        <i class="bi bi-people-fill me-2"></i>
        Jugadores Transferibles
      </h1>
      <p class="players-subtitle">
        Transferencias abiertas. ¿A quién fichás para tu equipo campeón?
      </p>
    </div>

    <div class="header-actions">
      <button class="btn-create-team" (click)="onListBirdAdmin()" *ngIf="loginService?.user?.idRol == 1">
        <i class="bi bi-list me-2"></i>
        Comprobar Ofertas
      </button>

      <button class="btn-assign-manager" (click)="onListBird()">
        <i class="bi bi-hand-thumbs-up me-2"></i>
        Mis ofertas
      </button>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="playersList?.length === 0">
    <i class="bi bi-person-x empty-icon"></i>
    <h3>No hay jugadores disponibles</h3>
    <p>No hay jugadores transferibles en este momento</p>
  </div>

  <!-- Grid de cards -->
  <div class="players-grid" *ngIf="playersList?.length > 0">
    <div class="player-card" *ngFor="let player of playersList">
      <div class="player-card-inner">
        <!-- Glow effect -->
        <div class="card-glow"></div>
        
        <!-- Player Photo Container -->
        <div class="player-photo-container">
          <div class="photo-wrapper">
            <img
              [src]="player?.photo?.secureUrl || '../../../assets/images/player-default.png'"
              [alt]="player.fullName"
              class="player-photo"
            />
          </div>
        </div>

        <!-- Content -->
        <div class="player-content">
          <h3 class="player-name">{{ player.fullName }}</h3>
          
          <!-- Team Info -->
          <div class="player-team" *ngIf="player?.team">
            <div class="team-logo-wrapper">
              <img
                [src]="player?.team?.logo?.secureUrl || '../../../assets/images/player-default.png'"
                [alt]="player.team.name"
                class="team-logo"
              />
            </div>
            <span class="team-name">{{ player.team.name }}</span>
          </div>

          <!-- Stats -->
          <div class="player-stats">
            <div class="stat-item">
              <span class="stat-label">Valoración</span>
              <span class="rating-badge">{{ player.valoration }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Posición</span>
              <span
                class="position-tag"
                [ngClass]="{
                  gk: player.position == 'GK',
                  defence: player.position == 'DFI' || player.position == 'DFC' || player.position == 'DFD',
                  medio: player.position == 'MCO',
                  attack: player.position == 'DC'
                }"
              >
                {{ player?.position }}
              </span>
            </div>
          </div>

          <!-- Footer -->
          <div class="player-footer" *ngIf="loginService.user.idTeam !== player.team.id">
            <button class="btn-offer" (click)="onBird(player)">
              <i class="bi bi-hand-thumbs-up me-2"></i>
              Ofertar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<nz-modal
  [(nzVisible)]="isVisible"
  [nzTitle]="modalTitle"
  [nzContent]="modalContent"
  [nzFooter]="modalFooter"
  [nzWidth]="'95vw'"
  [nzStyle]="{ maxWidth: '1000px' }"
  [nzBodyStyle]="{ padding: '16px', maxHeight: '70vh', overflowY: 'auto' }"
  [nzCentered]="true"
  (nzOnCancel)="handleCancel()"
  nzClassName="transfer-modal"
>
  <ng-template #modalTitle>
    <div class="modal-title-custom">
      <i class="bi bi-arrow-left-right"></i>
      <span>Oferta de transferencia</span>
    </div>
  </ng-template>

  <ng-template #modalContent>
    <!-- Encabezado con equipos -->
    <div class="teams-header-container">
      <div class="team-header-card incoming">
        <div class="team-header-badge">RECIBO</div>
        <img
          [src]="player?.team?.logo?.secureUrl || '../../../assets/images/player-default.png'"
          [alt]="player?.team?.name"
          class="team-header-logo"
        />
        <div class="team-header-info">
          <span class="team-header-name">{{ player?.team?.name }}</span>
        </div>
      </div>

      <div class="exchange-icon-container">
        <i class="bi bi-arrow-left-right"></i>
      </div>

      <div class="team-header-card outgoing">
        <div class="team-header-badge">OFREZCO</div>
        <img
          [src]="team?.logo?.secureUrl || '../../../assets/images/player-default.png'"
          [alt]="team?.name"
          class="team-header-logo"
        />
        <div class="team-header-info">
          <span class="team-header-name">{{ team?.name }}</span>
        </div>
      </div>
    </div>

    <form [formGroup]="form" nz-form [nzLayout]="'vertical'">
      <div class="transfer-columns">
        <!-- Jugadores Entrantes (del equipo objetivo) -->
        <div class="transfer-column incoming-column">
          <div class="column-header">
            <span class="column-title">Jugadores que quiero</span>
            <span class="selection-badge">Máx. {{ MAX_PLAYERS_SELECTION }}</span>
          </div>
          
          <nz-form-item>
            <nz-form-control nzErrorTip="Selecciona al menos un jugador">
              <nz-select
                formControlName="playersOut"
                nzMode="multiple"
                nzPlaceHolder="Toca para seleccionar..."
                [nzMaxTagCount]="3"
                nzShowSearch
                [nzDropdownMatchSelectWidth]="false"
                (ngModelChange)="onPlayersOutChange($event)"
              >
                <nz-option
                  *ngFor="let item of targetTeamPlayers"
                  [nzValue]="item.id"
                  [nzLabel]="item.name + ' ' + item.lastName + ' (' + item.position + ')'"
                ></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
          
          <!-- Preview de jugadores entrantes seleccionados -->
          <div class="selected-players-preview" *ngIf="form.get('playersOut').value?.length > 0">
            <div class="preview-players">
              <div class="preview-player" *ngFor="let playerId of form.get('playersOut').value">
                <ng-container *ngFor="let p of targetTeamPlayers">
                  <ng-container *ngIf="p.id === playerId">
                    <img 
                      [src]="p?.photo?.secureUrl || '../../../assets/images/player-default.png'" 
                      [alt]="p.name"
                      class="preview-player-photo"
                    />
                    <div class="preview-player-info">
                      <span class="preview-player-name">{{ p.name }} {{ p.lastName }}</span>
                      <span class="preview-player-position">{{ p.position }}</span>
                    </div>
                  </ng-container>
                </ng-container>
              </div>
            </div>
          </div>

          <!-- Empty state -->
          <div class="empty-selection" *ngIf="!form.get('playersOut').value?.length">
            <i class="bi bi-person-plus"></i>
            <span>Selecciona jugadores</span>
          </div>
        </div>

        <!-- Jugadores de Salida (de mi equipo) -->
        <div class="transfer-column outgoing-column">
          <div class="column-header">
            <span class="column-title">Jugadores que ofrezco</span>
            <span class="selection-badge">Máx. {{ MAX_PLAYERS_SELECTION }}</span>
          </div>

          <nz-form-item>
            <nz-form-control nzErrorTip="Selecciona al menos un jugador">
              <nz-select
                formControlName="playersIn"
                nzMode="multiple"
                nzPlaceHolder="Toca para seleccionar..."
                [nzMaxTagCount]="3"
                nzShowSearch
                [nzDropdownMatchSelectWidth]="false"
                (ngModelChange)="onPlayersInChange($event)"
              >
                <nz-option
                  *ngFor="let item of myPlayers"
                  [nzValue]="item.id"
                  [nzLabel]="item.name + ' ' + item.lastName + ' (' + item.position + ')'"
                ></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>

          <!-- Preview de jugadores de salida seleccionados -->
          <div class="selected-players-preview" *ngIf="form.get('playersIn').value?.length > 0">
            <div class="preview-players">
              <div class="preview-player" *ngFor="let playerId of form.get('playersIn').value">
                <ng-container *ngFor="let p of myPlayers">
                  <ng-container *ngIf="p.id === playerId">
                    <img 
                      [src]="p?.photo?.secureUrl || '../../../assets/images/player-default.png'" 
                      [alt]="p.name"
                      class="preview-player-photo"
                    />
                    <div class="preview-player-info">
                      <span class="preview-player-name">{{ p.name }} {{ p.lastName }}</span>
                      <span class="preview-player-position">{{ p.position }}</span>
                    </div>
                  </ng-container>
                </ng-container>
              </div>
            </div>
          </div>

          <!-- Empty state -->
          <div class="empty-selection" *ngIf="!form.get('playersIn').value?.length">
            <i class="bi bi-person-dash"></i>
            <span>Selecciona jugadores</span>
          </div>
        </div>
      </div>
    </form>

    <!-- Resumen del intercambio -->
    <div class="exchange-summary" *ngIf="form.get('playersOut').value?.length > 0 && form.get('playersIn').value?.length > 0">
      <div class="summary-content">
        <div class="summary-item incoming">
          <i class="bi bi-arrow-down-circle-fill"></i>
          <strong>{{ form.get('playersOut').value?.length }}</strong>
          <span>entrante(s)</span>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-item outgoing">
          <i class="bi bi-arrow-up-circle-fill"></i>
          <strong>{{ form.get('playersIn').value?.length }}</strong>
          <span>saliente(s)</span>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template #modalFooter>
    <div class="modal-footer-custom">
      <button class="btn-cancel" (click)="handleCancel()">
        <i class="bi bi-x-lg"></i>
        <span>Cancelar</span>
      </button>
      <button 
        class="btn-confirm" 
        (click)="onSubmit()"
        [disabled]="!form.get('playersOut').value?.length || !form.get('playersIn').value?.length"
      >
        <i class="bi bi-check-lg"></i>
        <span>Confirmar Oferta</span>
      </button>
    </div>
  </ng-template>
</nz-modal>
